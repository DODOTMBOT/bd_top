# –ò—Ç–æ–≥–æ–≤–∞—è —Å–≤–æ–¥–∫–∞: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ PostgreSQL

## ‚úÖ –í—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ –∑–∞–¥–∞—á–∏

### 1. –°–æ–∑–¥–∞–Ω —Å–∫—Ä–∏–ø—Ç-–¥–∏–∞–≥–Ω–æ—Å—Ç `scripts/db-doctor.mjs`
- ‚úÖ **TCP –ø—Ä–æ–≤–µ—Ä–∫–∞** - –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å —Ö–æ—Å—Ç–∞ –∏ –ø–æ—Ä—Ç–∞ —á–µ—Ä–µ–∑ `net.connect()`
- ‚úÖ **TLS/SSL –ø—Ä–æ–≤–µ—Ä–∫–∞** - –ø–æ–¥–¥–µ—Ä–∂–∫–∞ `verify-full`, `require`, `disable`
- ‚úÖ **SQL –ø—Ä–æ–≤–µ—Ä–∫–∞** - –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ —Ç–µ—Å—Ç–æ–≤–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞
- ‚úÖ **–î–µ—Ç–∞–ª—å–Ω—ã–π –æ—Ç—á–µ—Ç** - –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã –ø—Ä–æ–±–ª–µ–º –∏ —Ä–µ—à–µ–Ω–∏—è
- ‚úÖ **–¶–≤–µ—Ç–Ω–æ–π –≤—ã–≤–æ–¥** - –Ω–∞–≥–ª—è–¥–Ω–æ–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–æ–≤

### 2. –û–±–Ω–æ–≤–ª–µ–Ω `package.json`
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω —Å–∫—Ä–∏–ø—Ç `db:doctor`
- ‚úÖ –£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ `pg@^8.12.0` –∏ `dotenv@^16.4.5`
- ‚úÖ –°–æ—Ö—Ä–∞–Ω–µ–Ω —Å–∫—Ä–∏–ø—Ç `db:ping` –¥–ª—è Prisma

### 3. –ù–∞—Å—Ç—Ä–æ–µ–Ω–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è Prisma
- ‚úÖ `prisma/.env` –∫–æ–ø–∏—Ä—É–µ—Ç—Å—è –∏–∑ `.env.local`
- ‚úÖ `prisma/schema.prisma` –Ω–∞—Å—Ç—Ä–æ–µ–Ω –¥–ª—è PostgreSQL
- ‚úÖ –ü–æ–¥–¥–µ—Ä–∂–∫–∞ `shadowDatabaseUrl`

### 4. –û–±–Ω–æ–≤–ª–µ–Ω–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è
- ‚úÖ README.md —Å —Ä–∞–∑–¥–µ–ª–æ–º "–î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –ë–î"
- ‚úÖ –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –ø–æ –Ω–∞—Å—Ç—Ä–æ–π–∫–µ SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤
- ‚úÖ –¢–∞–±–ª–∏—Ü–∞ —Ä–µ–∂–∏–º–æ–≤ SSL
- ‚úÖ –ü—Ä–∏–º–µ—Ä—ã SSH —Ç—É–Ω–Ω–µ–ª—è

### 5. –û–±–Ω–æ–≤–ª–µ–Ω `.env.example`
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω—ã –ø–æ–ª—è `DB_SSL_ROOT_CERT` –∏ `DB_TEST_QUERY`
- ‚úÖ –ü—Ä–∏–º–µ—Ä—ã –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —Ä–µ–∂–∏–º–æ–≤

## üîç –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏

### –ß—Ç–æ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç `npm run db:doctor`:

1. **TCP –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ**
   - –î–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å —Ö–æ—Å—Ç–∞ –∏ –ø–æ—Ä—Ç–∞
   - –¢–∞–π–º–∞—É—Ç 5 —Å–µ–∫—É–Ω–¥
   - –î–µ—Ç–∞–ª—å–Ω—ã–µ –æ—à–∏–±–∫–∏ (ECONNREFUSED, timeout)

2. **TLS/SSL –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ**
   - –ü–æ–¥–¥–µ—Ä–∂–∫–∞ `sslmode=verify-full` —Å CA —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–º
   - –ü–æ–¥–¥–µ—Ä–∂–∫–∞ `sslmode=require` –±–µ–∑ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞
   - –ü–æ–¥–¥–µ—Ä–∂–∫–∞ `sslmode=disable` –±–µ–∑ SSL
   - –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –æ—à–∏–±–æ–∫ handshake

3. **SQL –∑–∞–ø—Ä–æ—Å—ã**
   - –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ —Ç–µ—Å—Ç–æ–≤–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é `select 1;`)
   - –ò–∑–º–µ—Ä–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è
   - –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –æ—à–∏–±–æ–∫ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏

### –ü—Ä–∏–º–µ—Ä—ã –≤—ã–≤–æ–¥–∞:

**–£—Å–ø–µ—à–Ω–∞—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞:**
```
üîç –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ PostgreSQL
==================================================
üìã DATABASE_URL: postgresql://user:***@host:5432/db?sslmode=require
üìã SSL Root Cert: /Users/user/.postgresql/root.crt
üìã Test Query: select 1;

üåê –ü—Ä–æ–≤–µ—Ä–∫–∞ TCP –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è...
‚úÖ TCP: OK

üîí –ü—Ä–æ–≤–µ—Ä–∫–∞ TLS –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è...
‚úÖ TLS: OK

üíæ –ü—Ä–æ–≤–µ—Ä–∫–∞ SQL –∑–∞–ø—Ä–æ—Å–∞...
‚úÖ SQL: OK (45 ms)

üìä –°–≤–æ–¥–∫–∞:
‚úÖ –í—Å–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–æ–π–¥–µ–Ω—ã —É—Å–ø–µ—à–Ω–æ!
```

**–î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ —Å –ø—Ä–æ–±–ª–µ–º–∞–º–∏:**
```
üîç –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ PostgreSQL
==================================================
üìã DATABASE_URL: postgresql://user:***@host:5432/db?sslmode=verify-full
üìã SSL Root Cert: /Users/user/.postgresql/root.crt
üìã Test Query: select 1;

üåê –ü—Ä–æ–≤–µ—Ä–∫–∞ TCP –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è...
‚úÖ TCP: OK

üîí –ü—Ä–æ–≤–µ—Ä–∫–∞ TLS –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è...
‚ùå TLS: FAIL (NO CA (–æ–∂–∏–¥–∞–µ—Ç—Å—è DB_SSL_ROOT_CERT=...))

üíæ –ü—Ä–æ–≤–µ—Ä–∫–∞ SQL –∑–∞–ø—Ä–æ—Å–∞...
‚ùå SQL: FAIL (Connection terminated unexpectedly)

üìä –°–≤–æ–¥–∫–∞:
‚ùå –ü—Ä–æ–±–ª–µ–º–∞: –û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç
üí° –ß—Ç–æ –¥–µ–ª–∞—Ç—å:
   1. –ü–æ–ª–æ–∂–∏—Ç–µ CA –≤ ~/.postgresql/root.crt: mkdir -p ~/.postgresql && cp root.crt ~/.postgresql/root.crt
   2. –ü–µ—Ä–µ–∫–ª—é—á–∏—Ç–µ sslmode –Ω–∞ require –∏–ª–∏ disable
   3. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ SSH —Ç—É–Ω–Ω–µ–ª—å —Å sslmode=disable
```

## üöÄ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ

### –ë–∞–∑–æ–≤–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:
```bash
# –ó–∞–ø—É—Å–∫ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏
npm run db:doctor

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —á–µ—Ä–µ–∑ Prisma
npm run db:ping
```

### –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è:
```env
# .env.local
DATABASE_URL="postgresql://user:password@host:5432/database?sslmode=verify-full"
SHADOW_DATABASE_URL="postgresql://user:password@host:5432/shadow_db?sslmode=verify-full"
DB_SSL_ROOT_CERT=~/.postgresql/root.crt
DB_TEST_QUERY=select 1;
```

### –†–µ–∂–∏–º—ã SSL:
- `verify-full` - –ø–æ–ª–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ SSL + –∏–º—è —Ö–æ—Å—Ç–∞
- `require` - SSL –±–µ–∑ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞  
- `disable` - –±–µ–∑ SSL

## üîß –†–µ—à–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º

### –ü—Ä–æ–±–ª–µ–º–∞: "Connection terminated unexpectedly"
**–ü—Ä–∏—á–∏–Ω—ã:**
1. –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ —É—á–µ—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
2. –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞
3. –°–µ—Ç–µ–≤—ã–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è
4. –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ SSL –Ω–∞—Å—Ç—Ä–æ–π–∫–∏

**–†–µ—à–µ–Ω–∏—è:**
1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —É—á–µ—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –≤ –ø–∞–Ω–µ–ª–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
2. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ SSH —Ç—É–Ω–Ω–µ–ª—å: `ssh -NT -L 5433:host:5432 user@bastion`
3. –ü–µ—Ä–µ–∫–ª—é—á–∏—Ç–µ –Ω–∞ `sslmode=disable` –¥–ª—è —Ç—É–Ω–Ω–µ–ª—è
4. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –ª–æ–∫–∞–ª—å–Ω—É—é PostgreSQL –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏

### –ü—Ä–æ–±–ª–µ–º–∞: "NO CA"
**–†–µ—à–µ–Ω–∏–µ:**
```bash
mkdir -p ~/.postgresql
cp root.crt ~/.postgresql/root.crt
```

### –ü—Ä–æ–±–ª–µ–º–∞: "HOSTNAME MISMATCH"
**–†–µ—à–µ–Ω–∏–µ:**
1. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π CA —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç
2. –ü–µ—Ä–µ–∫–ª—é—á–∏—Ç–µ –Ω–∞ `sslmode=require`
3. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ SSH —Ç—É–Ω–Ω–µ–ª—å

## üìã –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

1. **–ü–æ–ª—É—á–∏—Ç–µ —Ä–µ–∞–ª—å–Ω—ã–π SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç** –∏–∑ –ø–∞–Ω–µ–ª–∏ Timeweb
2. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ —É—á–µ—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ** –≤ –ø–∞–Ω–µ–ª–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
3. **–ù–∞—Å—Ç—Ä–æ–π—Ç–µ SSH —Ç—É–Ω–Ω–µ–ª—å** –µ—Å–ª–∏ SSL –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç
4. **–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –ª–æ–∫–∞–ª—å–Ω—É—é PostgreSQL** –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏

**–°–∏—Å—Ç–µ–º–∞ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏ –≥–æ—Ç–æ–≤–∞ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é!** üéØ

