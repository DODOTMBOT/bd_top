#!/bin/bash

echo "ðŸš€ Ð—Ð°Ð¿ÑƒÑÐº SSH Ñ‚ÑƒÐ½Ð½ÐµÐ»Ñ Ð´Ð»Ñ PostgreSQL..."

# ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼, Ð½Ðµ Ð·Ð°Ð¿ÑƒÑ‰ÐµÐ½ Ð»Ð¸ ÑƒÐ¶Ðµ Ñ‚ÑƒÐ½Ð½ÐµÐ»ÑŒ
if lsof -Pi :5433 -sTCP:LISTEN -t >/dev/null ; then
    echo "âš ï¸  Ð¢ÑƒÐ½Ð½ÐµÐ»ÑŒ ÑƒÐ¶Ðµ Ð·Ð°Ð¿ÑƒÑ‰ÐµÐ½ Ð½Ð° Ð¿Ð¾Ñ€Ñ‚Ñƒ 5433"
    echo "Ð”Ð»Ñ Ð¾ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ¸ Ð²Ñ‹Ð¿Ð¾Ð»Ð½Ð¸Ñ‚Ðµ: kill \$(lsof -ti:5433)"
    exit 1
fi

# Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ SSH Ñ‚ÑƒÐ½Ð½ÐµÐ»ÑŒ Ð² Ñ„Ð¾Ð½Ð¾Ð²Ð¾Ð¼ Ñ€ÐµÐ¶Ð¸Ð¼Ðµ
echo "ðŸ“¡ Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ñ‚ÑƒÐ½Ð½ÐµÐ»ÑŒ: localhost:5433 -> 910e913fe01583491138102e.twc1.net:5432"
ssh -NT -L 5433:910e913fe01583491138102e.twc1.net:5432 user@bastion-server &
TUNNEL_PID=$!

# Ð–Ð´ÐµÐ¼ Ð½ÐµÐ¼Ð½Ð¾Ð³Ð¾ Ð´Ð»Ñ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ¸ ÑÐ¾ÐµÐ´Ð¸Ð½ÐµÐ½Ð¸Ñ
sleep 2

# ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼, Ñ‡Ñ‚Ð¾ Ñ‚ÑƒÐ½Ð½ÐµÐ»ÑŒ Ð·Ð°Ð¿ÑƒÑÑ‚Ð¸Ð»ÑÑ
if lsof -Pi :5433 -sTCP:LISTEN -t >/dev/null ; then
    echo "âœ… Ð¢ÑƒÐ½Ð½ÐµÐ»ÑŒ ÑƒÑÐ¿ÐµÑˆÐ½Ð¾ Ð·Ð°Ð¿ÑƒÑ‰ÐµÐ½ Ñ PID: $TUNNEL_PID"
    echo "ðŸ”— Ð›Ð¾ÐºÐ°Ð»ÑŒÐ½Ñ‹Ð¹ Ð¿Ð¾Ñ€Ñ‚: 5433"
    echo "ðŸŽ¯ Ð£Ð´Ð°Ð»ÐµÐ½Ð½Ñ‹Ð¹ Ñ…Ð¾ÑÑ‚: 910e913fe01583491138102e.twc1.net:5432"
    echo ""
    echo "Ð”Ð»Ñ Ð¾ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ¸ Ð²Ñ‹Ð¿Ð¾Ð»Ð½Ð¸Ñ‚Ðµ:"
    echo "  kill $TUNNEL_PID"
    echo "  Ð¸Ð»Ð¸"
    echo "  kill \$(lsof -ti:5433)"
    echo ""
    echo "Ð”Ð»Ñ Ñ‚ÐµÑÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ Ð¿Ð¾Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ñ:"
    echo "  psql \"postgresql://gen_user:K2%285W_cQSHpplS@localhost:5433/default_db?sslmode=disable\" -c \"select 1;\""
else
    echo "âŒ ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ Ð·Ð°Ð¿ÑƒÑÑ‚Ð¸Ñ‚ÑŒ Ñ‚ÑƒÐ½Ð½ÐµÐ»ÑŒ"
    echo "ÐŸÑ€Ð¾Ð²ÐµÑ€ÑŒÑ‚Ðµ:"
    echo "  - Ð”Ð¾ÑÑ‚ÑƒÐ¿Ð½Ð¾ÑÑ‚ÑŒ SSH ÑÐµÑ€Ð²ÐµÑ€Ð°"
    echo "  - ÐŸÑ€Ð°Ð²Ð¸Ð»ÑŒÐ½Ð¾ÑÑ‚ÑŒ ÑƒÑ‡ÐµÑ‚Ð½Ñ‹Ñ… Ð´Ð°Ð½Ð½Ñ‹Ñ…"
    echo "  - Ð¡ÐµÑ‚ÐµÐ²Ñ‹Ðµ Ð¾Ð³Ñ€Ð°Ð½Ð¸Ñ‡ÐµÐ½Ð¸Ñ"
    kill $TUNNEL_PID 2>/dev/null
    exit 1
fi

